
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>pynbody.units &mdash; pynbody 0.18-alpha documentation</title>
    
    <link rel="stylesheet" href="../../_static/nature.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '0.18-alpha',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="top" title="pynbody 0.18-alpha documentation" href="../../index.html" />
    <link rel="up" title="Module code" href="../index.html" />
 
<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-38063425-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>

  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../index.html">pynbody 0.18-alpha documentation</a> &raquo;</li>
          <li><a href="../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for pynbody.units</h1><div class="highlight"><pre>
<span class="sd">&quot;&quot;&quot;</span>

<span class="sd">units</span>
<span class="sd">=====</span>

<span class="sd">The pynbody units module consists of a set of classes for tracking units.</span>

<span class="sd">It relates closely to the :mod:`~pynbody.array` module, which defines</span>
<span class="sd">an extension to numpy arrays which carries unit information.</span>

<span class="sd">Making units</span>
<span class="sd">------------</span>

<span class="sd">Units are generated and used at various points through the pynbody</span>
<span class="sd">framework. Quite often the functions where users interact with units</span>
<span class="sd">simply accept strings.</span>

<span class="sd">You can also make units yourself in two ways. Either you can create a string, and</span>
<span class="sd">instantiate a Unit like this:</span>

<span class="sd">&gt;&gt;&gt; units.Unit(&quot;Msol kpc**-3&quot;)</span>
<span class="sd">&gt;&gt;&gt; units.Unit(&quot;2.1e12 m_p cm**-2/3&quot;)</span>

<span class="sd">Or you can do it within python, using the named Unit objects</span>

<span class="sd">&gt;&gt;&gt; units.Msol * units.kpc**-3</span>
<span class="sd">&gt;&gt;&gt; 2.1e12 * units.m_p * units.cm**(-2,3)</span>

<span class="sd">In the last example, either a tuple describing a fraction or a</span>
<span class="sd">Fraction instance (from the standard python module fractions) is</span>
<span class="sd">acceptable.</span>


<span class="sd">Getting conversion ratios</span>
<span class="sd">-------------------------</span>

<span class="sd">To convert one unit to another, use the ``ratio`` member function:</span>

<span class="sd">&gt;&gt;&gt; units.Msol.ratio(units.kg)</span>
<span class="sd">1.99e30</span>
<span class="sd">&gt;&gt;&gt; (units.Msol / units.kpc**3).ratio(units.m_p/units.cm**3)</span>
<span class="sd">4.04e-8</span>

<span class="sd">If the units cannot be converted, a UnitsException is raised:</span>

<span class="sd">&gt;&gt;&gt; units.Msol.ratio(units.kpc)</span>
<span class="sd">UnitsException</span>

<span class="sd">Specifying numerical values</span>
<span class="sd">---------------------------</span>

<span class="sd">Sometimes it&#39;s necessary to specify a numerical value in the course</span>
<span class="sd">of a conversion. For instance, consider a comoving distance; this</span>
<span class="sd">can be specified in pynbody units as follows:</span>

<span class="sd">&gt;&gt;&gt; comoving_kpc = units.kpc * units.a</span>

<span class="sd">where units.a represents the scalefactor. We can attempt to convert</span>
<span class="sd">this to a physical distance as follows</span>

<span class="sd">&gt;&gt;&gt; comoving_kpc.ratio(units.kpc)</span>

<span class="sd">but this fails, throwing a UnitsException. On the other hand we</span>
<span class="sd">can specify a value for the scalefactor when we request the conversion</span>

<span class="sd">&gt;&gt;&gt; comoving_kpc.ratio(units.kpc, a=0.5)</span>
<span class="sd">0.5</span>

<span class="sd">and the conversion completes with the expected result. The units</span>
<span class="sd">module also defines units.h for the dimensionless hubble constant,</span>
<span class="sd">which can be used similarly. *By default, all conversions happening</span>
<span class="sd">within a specific simulation context should pass in values for</span>
<span class="sd">a and h as a matter of routine.*</span>

<span class="sd">Any IrreducibleUnit (see below) can have a value specified in this way,</span>
<span class="sd">but a and h are envisaged to be the most useful applications.</span>

<span class="sd">Defining new base units</span>
<span class="sd">-----------------------</span>

<span class="sd">The units module is fully extensible: you can define and name your own</span>
<span class="sd">units which then integrate with all the standard functions.</span>

<span class="sd">.. code-block:: python</span>

<span class="sd">   litre = units.NamedUnit(&quot;litre&quot;,0.001*units.m**3)</span>
<span class="sd">   gallon = units.NamedUnit(&quot;gallon&quot;,0.004546*units.m**3)</span>
<span class="sd">   gallon.ratio(litre) # 4.546</span>
<span class="sd">   (units.pc**3).ratio(litre) # 2.94e52</span>


<span class="sd">You can even define completely new dimensions.</span>

<span class="sd">.. code-block:: python</span>

<span class="sd">    V = units.IrreducibleUnit(&quot;V&quot;) # define a volt</span>
<span class="sd">    C = units.NamedUnit(&quot;C&quot;, units.J/V) # define a coulomb</span>
<span class="sd">    q = units.NamedUnit(&quot;q&quot;, 1.60217646e-19*C) # elementary charge</span>
<span class="sd">    F = units.NamedUnit(&quot;F&quot;, C/V) # Farad</span>
<span class="sd">    epsilon0 = 8.85418e-12 *F/units.m</span>


<span class="sd">&gt;&gt;&gt; (q*V).ratio(&quot;eV&quot;)</span>
<span class="sd">1.000</span>
<span class="sd">&gt;&gt;&gt; ((q**2)/(4*math.pi*epsilon0*units.m**2)).ratio(&quot;N&quot;)</span>
<span class="sd">2.31e-28</span>


<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">keyword</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">backcompat</span>
<span class="kn">from</span> <span class="nn">.backcompat</span> <span class="kn">import</span> <span class="n">fractions</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">util</span>
<span class="kn">import</span> <span class="nn">functools</span>

<span class="n">Fraction</span> <span class="o">=</span> <span class="n">fractions</span><span class="o">.</span><span class="n">Fraction</span>

<span class="n">_registry</span> <span class="o">=</span> <span class="p">{}</span>


<span class="k">class</span> <span class="nc">UnitsException</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span>


<div class="viewcode-block" id="UnitBase"><a class="viewcode-back" href="../../essentials.html#pynbody.units.UnitBase">[docs]</a><span class="k">class</span> <span class="nc">UnitBase</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Base class for units. To instantiate a unit, call the :func:`pynbody.units.Unit`</span>
<span class="sd">    factory function.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Cannot directly initialize abstract base class&quot;</span><span class="p">)</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">__pow__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">Fraction</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">CompositeUnit</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="p">],</span> <span class="p">[</span><span class="n">p</span><span class="p">])</span><span class="o">.</span><span class="n">simplify</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__truediv__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">m</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__div__</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
     
    <span class="k">def</span> <span class="nf">__div__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">m</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;_no_unit&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">NoUnit</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">UnitBase</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">CompositeUnit</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="p">,</span> <span class="n">m</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">simplify</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">CompositeUnit</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="n">m</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">simplify</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__rdiv__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">m</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">CompositeUnit</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">simplify</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__mul__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">m</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;_no_unit&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">NoUnit</span><span class="p">()</span>
        <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;units&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">m</span> <span class="o">*</span> <span class="bp">self</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">UnitBase</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">CompositeUnit</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="p">,</span> <span class="n">m</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">simplify</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">CompositeUnit</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">simplify</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__rmul__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">m</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">CompositeUnit</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">simplify</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__add__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">m</span><span class="p">):</span>
        <span class="n">scale</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">in_units</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&#39;in_units&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="n">m</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">scale</span><span class="p">,</span> <span class="s">&#39;units&#39;</span><span class="p">)</span> <span class="p">:</span>
           <span class="n">scale</span><span class="o">.</span><span class="n">units</span><span class="o">=</span><span class="mi">1</span>
        <span class="k">return</span> <span class="bp">self</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">scale</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__sub__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">m</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span> <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="n">m</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&#39;Unit(&quot;&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;&quot;)&#39;</span>

    <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ratio</span><span class="p">(</span><span class="n">other</span><span class="p">)</span> <span class="o">==</span> <span class="mf">1.</span>
        <span class="k">except</span> <span class="n">UnitsException</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">__ne__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span> <span class="o">==</span> <span class="n">other</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__lt__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ratio</span><span class="p">(</span><span class="n">other</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1.</span>

    <span class="k">def</span> <span class="nf">__gt__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ratio</span><span class="p">(</span><span class="n">other</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">1.</span>

    <span class="k">def</span> <span class="nf">__le__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ratio</span><span class="p">(</span><span class="n">other</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mf">1.</span>

    <span class="k">def</span> <span class="nf">__ge__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ratio</span><span class="p">(</span><span class="n">other</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mf">1.</span>

    <span class="k">def</span> <span class="nf">__neg__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__float__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="p">:</span>
        <span class="k">return</span> <span class="mf">1.</span>

    <span class="k">def</span> <span class="nf">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="p">:</span>
        <span class="k">return</span> <span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">simplify</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">is_dimensionless</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">False</span>

<div class="viewcode-block" id="UnitBase.ratio"><a class="viewcode-back" href="../../essentials.html#pynbody.units.UnitBase.ratio">[docs]</a>    <span class="k">def</span> <span class="nf">ratio</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span> <span class="o">**</span><span class="n">substitutions</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the conversion ratio between this Unit and another</span>
<span class="sd">        specified unit.</span>

<span class="sd">        Keyword arguments, if specified, give numerical substitutions</span>
<span class="sd">        for the named unit. This is most useful for specifying values</span>
<span class="sd">        for cosmological quantities like &#39;a&#39; and &#39;h&#39;, but can also</span>
<span class="sd">        be used for any IrreducibleUnit.</span>

<span class="sd">        &gt;&gt;&gt; Unit(&quot;1 Mpc a&quot;).ratio(&quot;kpc&quot;, a=0.25)</span>
<span class="sd">        250.0</span>
<span class="sd">        &gt;&gt;&gt; Unit(&quot;1 Mpc&quot;).ratio(&quot;Msol&quot;)</span>
<span class="sd">        UnitsException: not convertible</span>
<span class="sd">        &gt;&gt;&gt; Unit(&quot;1 Mpc&quot;).ratio(&quot;Msol&quot;, kg=25.0, m=50.0)</span>
<span class="sd">        3.1028701506345152e-08</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">other</span> <span class="o">=</span> <span class="n">Unit</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="s">&quot;_no_unit&quot;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">UnitsException</span><span class="p">(</span><span class="s">&quot;Unknown units&quot;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="bp">self</span> <span class="o">/</span> <span class="n">other</span><span class="p">)</span><span class="o">.</span><span class="n">dimensionless_constant</span><span class="p">(</span><span class="o">**</span><span class="n">substitutions</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">UnitsException</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">UnitsException</span><span class="p">(</span><span class="s">&quot;Not convertible&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="UnitBase.in_units"><a class="viewcode-back" href="../../essentials.html#pynbody.units.UnitBase.in_units">[docs]</a>    <span class="k">def</span> <span class="nf">in_units</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Alias for ratio&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ratio</span><span class="p">(</span><span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="UnitBase.irrep"><a class="viewcode-back" href="../../essentials.html#pynbody.units.UnitBase.irrep">[docs]</a>    <span class="k">def</span> <span class="nf">irrep</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a unit equivalent to this one (may be identical) but</span>
<span class="sd">        expressed in terms of the currently defined IrreducibleUnit</span>
<span class="sd">        instances.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span>
</div>
    <span class="k">def</span> <span class="nf">_register_unit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">st</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">st</span> <span class="ow">in</span> <span class="n">_registry</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">UnitsException</span><span class="p">(</span><span class="s">&quot;Unit with this name already exists&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s">&quot;**&quot;</span> <span class="ow">in</span> <span class="n">st</span> <span class="ow">or</span> <span class="s">&quot;^&quot;</span> <span class="ow">in</span> <span class="n">st</span> <span class="ow">or</span> <span class="s">&quot; &quot;</span> <span class="ow">in</span> <span class="n">st</span><span class="p">:</span>
            <span class="c"># will cause problems for simple string parser in Unit() factory</span>
            <span class="k">raise</span> <span class="n">UnitsException</span><span class="p">,</span> <span class="s">&quot;Unit names cannot contain &#39;**&#39; or &#39;^&#39; or spaces&quot;</span>
        <span class="n">_registry</span><span class="p">[</span><span class="n">st</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">__deepcopy__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">memo</span><span class="p">):</span>
        <span class="c"># This may look odd, but the units conversion will be very</span>
        <span class="c"># broken after deep-copying if we don&#39;t guarantee that a given</span>
        <span class="c"># physical unit corresponds to only one instance</span>
        <span class="k">return</span> <span class="bp">self</span>

</div>
<span class="k">class</span> <span class="nc">NoUnit</span><span class="p">(</span><span class="n">UnitBase</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_no_unit</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">ratio</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span> <span class="o">**</span><span class="n">substitutions</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">NoUnit</span><span class="p">):</span>
            <span class="k">return</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">UnitsException</span><span class="p">(</span><span class="s">&quot;Unknown units&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">dimensional_project</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">UnitsException</span><span class="p">(</span><span class="s">&quot;Unknown units&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">is_dimensionless</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">simplify</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">__pow__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">__div__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">__rdiv__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">__mul__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">__rmul__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot;NoUnit()&quot;</span>

    <span class="k">def</span> <span class="nf">latex</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">irrep</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span>

<span class="n">no_unit</span> <span class="o">=</span> <span class="n">NoUnit</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">_resurrect_named_unit</span><span class="p">(</span><span class="n">unit_name</span><span class="p">,</span> <span class="n">unit_latex</span><span class="p">,</span> <span class="n">represents</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">unit_name</span> <span class="ow">in</span> <span class="n">_registry</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">_registry</span><span class="p">[</span><span class="n">unit_name</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">represents</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">nu</span> <span class="o">=</span> <span class="n">IrreducibleUnit</span><span class="p">(</span><span class="n">unit_name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">nu</span> <span class="o">=</span> <span class="n">NamedUnit</span><span class="p">(</span><span class="n">unit_name</span><span class="p">,</span> <span class="n">represents</span><span class="p">)</span>
            <span class="n">nu</span><span class="o">.</span><span class="n">_latex</span> <span class="o">=</span> <span class="n">unit_latex</span>
        <span class="k">return</span> <span class="n">nu</span>


<span class="k">class</span> <span class="nc">IrreducibleUnit</span><span class="p">(</span><span class="n">UnitBase</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">st</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_st_rep</span> <span class="o">=</span> <span class="n">st</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_register_unit</span><span class="p">(</span><span class="n">st</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__reduce__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">_resurrect_named_unit</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_st_rep</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_st_rep</span>

    <span class="k">def</span> <span class="nf">latex</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">r&quot;\mathrm{&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_st_rep</span> <span class="o">+</span> <span class="s">&quot;}&quot;</span>

    <span class="k">def</span> <span class="nf">irrep</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">CompositeUnit</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">])</span>


<span class="k">class</span> <span class="nc">NamedUnit</span><span class="p">(</span><span class="n">UnitBase</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">st</span><span class="p">,</span> <span class="n">represents</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_st_rep</span> <span class="o">=</span> <span class="n">st</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">represents</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">represents</span> <span class="o">=</span> <span class="n">Unit</span><span class="p">(</span><span class="n">represents</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_represents</span> <span class="o">=</span> <span class="n">represents</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_register_unit</span><span class="p">(</span><span class="n">st</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__reduce__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">_resurrect_named_unit</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_st_rep</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&#39;_latex&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_represents</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_st_rep</span>

    <span class="k">def</span> <span class="nf">latex</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&#39;_latex&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_latex</span>
        <span class="k">return</span> <span class="s">r&quot;\mathrm{&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_st_rep</span> <span class="o">+</span> <span class="s">&quot;}&quot;</span>

    <span class="k">def</span> <span class="nf">irrep</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_represents</span><span class="o">.</span><span class="n">irrep</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">CompositeUnit</span><span class="p">(</span><span class="n">UnitBase</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scale</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">powers</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize a composite unit.</span>

<span class="sd">        Direct use of this function is not recommended. Instead use the</span>
<span class="sd">        factory function Unit(...).&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">scale</span> <span class="o">==</span> <span class="mf">1.</span><span class="p">:</span>
            <span class="n">scale</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_scale</span> <span class="o">=</span> <span class="n">scale</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_bases</span> <span class="o">=</span> <span class="n">bases</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_powers</span> <span class="o">=</span> <span class="n">powers</span>

    <span class="k">def</span> <span class="nf">latex</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a LaTeX representation of this unit.</span>

<span class="sd">        Prefactors are converted into exponent notation. Named units by default</span>
<span class="sd">        are represented by the string &#39;\mathrm{unit_name}&#39;, although this can</span>
<span class="sd">        be overriden in the pynbody configuration files or by setting</span>
<span class="sd">        unit_name._latex.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scale</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="s">&quot;</span><span class="si">%.2e</span><span class="s">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scale</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;e&#39;</span><span class="p">)</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">ex</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s">&#39;0+&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">ex</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;-&#39;</span><span class="p">:</span>
                <span class="n">ex</span> <span class="o">=</span> <span class="s">&#39;-&#39;</span> <span class="o">+</span> <span class="p">(</span><span class="n">ex</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s">&#39;0&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ex</span> <span class="o">!=</span> <span class="s">&#39;&#39;</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="s">r&quot;\times 10^{&quot;</span> <span class="o">+</span> <span class="n">ex</span> <span class="o">+</span> <span class="s">&quot;}&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>

        <span class="k">for</span> <span class="n">b</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_bases</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_powers</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">s</span> <span class="o">!=</span> <span class="s">&quot;&quot;</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="s">r&quot;\,&quot;</span> <span class="o">+</span> <span class="n">b</span><span class="o">.</span><span class="n">latex</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">latex</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">p</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="s">&quot;^{&quot;</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="s">&quot;}&quot;</span>
        <span class="k">return</span> <span class="n">s</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_bases</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&quot;</span><span class="si">%.2e</span><span class="s">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scale</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scale</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%.2e</span><span class="s">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scale</span>

        <span class="k">for</span> <span class="n">b</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_bases</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_powers</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">s</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="s">&quot; &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">p</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="s">&quot;**&quot;</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">Fraction</span><span class="p">):</span>
                    <span class="n">s</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">s</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">s</span>

    <span class="k">def</span> <span class="nf">__float__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="p">:</span>
        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_scale</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_expand</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expand_to_irrep</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Internal routine to expand any pointers to composite units</span>
<span class="sd">        into direct pointers to the base units. If expand_to_irrep is</span>
<span class="sd">        True, everything is expressed in irreducible units.</span>
<span class="sd">        A _gather will normally be necessary to sanitize the unit</span>
<span class="sd">        after an _expand.&quot;&quot;&quot;</span>

        <span class="n">trash</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_bases</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_powers</span><span class="p">)):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">NamedUnit</span><span class="p">)</span> <span class="ow">and</span> <span class="n">expand_to_irrep</span><span class="p">:</span>
                <span class="n">b</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">_represents</span><span class="o">.</span><span class="n">irrep</span><span class="p">()</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">CompositeUnit</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">expand_to_irrep</span><span class="p">:</span>
                    <span class="n">b</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">irrep</span><span class="p">()</span>

                <span class="n">trash</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_scale</span> <span class="o">*=</span> <span class="n">b</span><span class="o">.</span><span class="n">_scale</span> <span class="o">**</span> <span class="n">p</span>
                <span class="k">for</span> <span class="n">b_sub</span><span class="p">,</span> <span class="n">p_sub</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">_bases</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">_powers</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_bases</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b_sub</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_powers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p_sub</span> <span class="o">*</span> <span class="n">p</span><span class="p">)</span>

        <span class="n">trash</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">offset</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">trash</span><span class="p">):</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bases</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="n">offset</span><span class="p">]</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_powers</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="n">offset</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_gather</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Internal routine to gather together powers of the same base</span>
<span class="sd">        units, then order the base units by their power (descending)&quot;&quot;&quot;</span>

        <span class="n">trash</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">bases</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_bases</span><span class="p">))</span>
        <span class="n">powers</span> <span class="o">=</span> <span class="p">[</span><span class="nb">sum</span><span class="p">([</span><span class="n">p</span> <span class="k">for</span> <span class="n">bi</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_bases</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_powers</span><span class="p">)</span>
                       <span class="k">if</span> <span class="n">bi</span> <span class="ow">is</span> <span class="n">b</span><span class="p">])</span>
                  <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">bases</span><span class="p">]</span>

        <span class="n">bp</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">,</span>
                           <span class="nb">zip</span><span class="p">(</span><span class="n">powers</span><span class="p">,</span> <span class="n">bases</span><span class="p">)),</span>
                    <span class="n">reverse</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                    <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="c"># Py2 only: cmp=lambda x, y: cmp(x[0], y[0]))</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_powers</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bases</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">bp</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_powers</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bases</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a copy which is &#39;shallow&#39; in the sense that it</span>
<span class="sd">        references exactly the same underlying base units, but where</span>
<span class="sd">        the list of those units can be manipulated separately.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">CompositeUnit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_scale</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bases</span><span class="p">[:],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_powers</span><span class="p">[:])</span>

    <span class="k">def</span> <span class="nf">__copy__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;For compatibility with python copy module&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">simplify</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_expand</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_gather</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">irrep</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a new unit which represents this unit expressed</span>
<span class="sd">        solely in terms of IrreducibleUnit bases.&quot;&quot;&quot;</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">x</span><span class="o">.</span><span class="n">_expand</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">x</span><span class="o">.</span><span class="n">_gather</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">x</span>

    <span class="k">def</span> <span class="nf">is_dimensionless</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns true if this unit actually translates into a scalar</span>
<span class="sd">        quantity.&quot;&quot;&quot;</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">irrep</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">_powers</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">dimensionless_constant</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">substitutions</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;If this unit is dimensionless, return its scalar quantity.</span>

<span class="sd">        Direct use of this function is not recommended. It is generally</span>
<span class="sd">        better to use the ratio function instead.</span>

<span class="sd">        Provide keyword arguments to set values for named IrreducibleUnits --</span>
<span class="sd">        see the ratio function for more information.&quot;&quot;&quot;</span>

        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">irrep</span><span class="p">()</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">_scale</span>
        <span class="k">for</span> <span class="n">xb</span><span class="p">,</span> <span class="n">xp</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">_bases</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">_powers</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">xb</span><span class="p">)</span> <span class="ow">in</span> <span class="n">substitutions</span><span class="p">:</span>
                <span class="n">c</span> <span class="o">*=</span> <span class="n">substitutions</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">xb</span><span class="p">)]</span> <span class="o">**</span> <span class="n">xp</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">UnitsException</span><span class="p">(</span><span class="s">&quot;Not dimensionless&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">c</span>

    <span class="k">def</span> <span class="nf">_power_of</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">base</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bases</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_powers</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_bases</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">base</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">dimensional_project</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">basis_units</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Work out how to express the dimensions of this unit relative to the</span>
<span class="sd">        specified list of basis units.</span>

<span class="sd">        This is used by the framework when making inferences about sensible units to</span>
<span class="sd">        use in various situations.</span>

<span class="sd">        For example, you can represent a length as an energy divided by a force:</span>

<span class="sd">           &gt;&gt;&gt; Unit(&quot;23 kpc&quot;).dimensional_project([&quot;J&quot;, &quot;N&quot;])</span>
<span class="sd">           array([1, -1], dtype=object)</span>

<span class="sd">        However it&#39;s not possible to represent a length by energy alone:</span>

<span class="sd">           &gt;&gt;&gt; Unit(&quot;23 kpc&quot;).dimensional_project([&quot;J&quot;])</span>
<span class="sd">           UnitsException: Basis units do not span dimensions of specified unit</span>

<span class="sd">        This function also doesn&#39;t know what to do if the result is ambiguous:</span>

<span class="sd">           &gt;&gt;&gt; Unit(&quot;23 kpc&quot;).dimensional_project([&quot;J&quot;, &quot;N&quot;, &quot;kpc&quot;])</span>
<span class="sd">           UnitsException: Basis units are not linearly independent</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">vec_irrep</span> <span class="o">=</span> <span class="p">[</span><span class="n">Unit</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">irrep</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">basis_units</span><span class="p">]</span>
        <span class="n">me_irrep</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">irrep</span><span class="p">()</span>
        <span class="n">bases</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">me_irrep</span><span class="o">.</span><span class="n">_bases</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">vec</span> <span class="ow">in</span> <span class="n">vec_irrep</span><span class="p">:</span>
            <span class="n">bases</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">vec</span><span class="o">.</span><span class="n">_bases</span><span class="p">)</span>

        <span class="n">bases</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">bases</span><span class="p">)</span>

        <span class="n">matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">bases</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">vec_irrep</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">Fraction</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">base_i</span><span class="p">,</span> <span class="n">base</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">bases</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">vec_i</span><span class="p">,</span> <span class="n">vec</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">vec_irrep</span><span class="p">):</span>
                <span class="n">matrix</span><span class="p">[</span><span class="n">base_i</span><span class="p">,</span> <span class="n">vec_i</span><span class="p">]</span> <span class="o">=</span> <span class="n">vec</span><span class="o">.</span><span class="n">_power_of</span><span class="p">(</span><span class="n">base</span><span class="p">)</span>

        <span class="c"># The matrix calculated above describes the transformation M</span>
        <span class="c"># such that v = M.d where d is the sought-after powers of the</span>
        <span class="c"># specified base vectors, and v is the powers in terms of the</span>
        <span class="c"># base units in the list bases.</span>
        <span class="c">#</span>
        <span class="c"># To invert, since M is possibly rectangular, we use the</span>
        <span class="c"># solution to the least-squares problem [minimize (v-M.d)^2]</span>
        <span class="c"># which is d = (M^T M)^(-1) M^T v.</span>
        <span class="c">#</span>
        <span class="c"># If the solution to that does not solve v = M.d, there is no</span>
        <span class="c"># admissable solution to v=M.d, i.e. the supplied base vectors do not</span>
        <span class="c"># span</span>
        <span class="c"># the requires space.</span>
        <span class="c">#</span>
        <span class="c"># If (M^T M) is singular, the vectors are not linearly independent, so</span>
        <span class="c"># any</span>
        <span class="c"># solution would not be unique.</span>
        <span class="n">M_T_M</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">matrix</span><span class="o">.</span><span class="n">transpose</span><span class="p">(),</span> <span class="n">matrix</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">M_T_M_inv</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">rational_matrix_inv</span><span class="p">(</span><span class="n">M_T_M</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">LinAlgError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">UnitsException</span><span class="p">(</span><span class="s">&quot;Basis units are not linearly independent&quot;</span><span class="p">)</span>

        <span class="n">my_powers</span> <span class="o">=</span> <span class="p">[</span><span class="n">me_irrep</span><span class="o">.</span><span class="n">_power_of</span><span class="p">(</span><span class="n">base</span><span class="p">)</span> <span class="k">for</span> <span class="n">base</span> <span class="ow">in</span> <span class="n">bases</span><span class="p">]</span>

        <span class="n">candidate</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">M_T_M_inv</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">matrix</span><span class="o">.</span><span class="n">transpose</span><span class="p">(),</span> <span class="n">my_powers</span><span class="p">))</span>

        <span class="c"># Because our method involves a loss of information (multiplying</span>
        <span class="c"># by M^T), we could get a spurious solution. Check this is not the</span>
        <span class="c"># case...</span>

        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">matrix</span><span class="p">,</span> <span class="n">candidate</span><span class="p">)</span> <span class="o">!=</span> <span class="n">my_powers</span><span class="p">):</span>
            <span class="c"># Spurious solution, meaning the base vectors did not span the</span>
            <span class="c"># units required in the first place.</span>
            <span class="k">raise</span> <span class="n">UnitsException</span><span class="p">(</span>
                <span class="s">&quot;Basis units do not span dimensions of specified unit&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">candidate</span>


<div class="viewcode-block" id="Unit"><a class="viewcode-back" href="../../essentials.html#pynbody.units.Unit">[docs]</a><span class="k">def</span> <span class="nf">Unit</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class factory for units. Given a string s, creates</span>
<span class="sd">    a Unit object.</span>

<span class="sd">    The string format is:</span>
<span class="sd">      [&lt;scale&gt;] [&lt;unit_name&gt;][**&lt;rational_power&gt;] [[&lt;unit_name&gt;] ... ]</span>

<span class="sd">    for example:</span>

<span class="sd">      &quot;1.e30 kg&quot;</span>

<span class="sd">      &quot;kpc**2&quot;</span>

<span class="sd">      &quot;26.2 m s**-1&quot;</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">UnitBase</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">s</span>

    <span class="n">x</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">scale</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">del</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">IndexError</span><span class="p">):</span>
        <span class="n">scale</span> <span class="o">=</span> <span class="mf">1.0</span>

    <span class="n">units</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">powers</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">com</span> <span class="ow">in</span> <span class="n">x</span><span class="p">:</span>
        <span class="k">if</span> <span class="s">&quot;**&quot;</span> <span class="ow">in</span> <span class="n">com</span> <span class="ow">or</span> <span class="s">&quot;^&quot;</span> <span class="ow">in</span> <span class="n">com</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">com</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;**&quot;</span> <span class="k">if</span> <span class="s">&quot;**&quot;</span> <span class="ow">in</span> <span class="n">com</span> <span class="k">else</span> <span class="s">&quot;^&quot;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">u</span> <span class="o">=</span> <span class="n">_registry</span><span class="p">[</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Unknown unit &quot;</span> <span class="o">+</span> <span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">Fraction</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">denominator</span> <span class="ow">is</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">numerator</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">u</span> <span class="o">=</span> <span class="n">_registry</span><span class="p">[</span><span class="n">com</span><span class="p">]</span>
            <span class="n">p</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="n">units</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
        <span class="n">powers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">CompositeUnit</span><span class="p">(</span><span class="n">scale</span><span class="p">,</span> <span class="n">units</span><span class="p">,</span> <span class="n">powers</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="takes_arg_in_units"><a class="viewcode-back" href="../../essentials.html#pynbody.units.takes_arg_in_units">[docs]</a><span class="k">def</span> <span class="nf">takes_arg_in_units</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">orig_kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    Returns a decorator to create a function which auto-converts input</span>
<span class="sd">    to given units.</span>

<span class="sd">    **Usage:**</span>

<span class="sd">    .. code-block:: python</span>

<span class="sd">        @takes_arg_in_units((2, &quot;Msol&quot;), (1, &quot;kpc&quot;), (&quot;blob&quot;, &quot;erg&quot;))</span>
<span class="sd">        def my_function(arg0, arg1, arg2, blob=22) :</span>
<span class="sd">           print &quot;Arg 2 is&quot;,arg2,&quot;Msol&quot;</span>
<span class="sd">           print &quot;Arg 1 is&quot;,arg1,&quot;kpc&quot;</span>
<span class="sd">           print &quot;blob is&quot;,blob,&quot;ergs&quot;</span>



<span class="sd">    &gt;&gt;&gt; My_function(22, &quot;1.e30 kg&quot;, 23, blob=&quot;12 J&quot;)</span>
<span class="sd">    Input 3 is 0.5 Msol</span>
<span class="sd">    Input 2 is 23 kpc</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">context_arg</span> <span class="o">=</span> <span class="n">orig_kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;context_arg&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

    <span class="n">kwargs</span> <span class="o">=</span> <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s">&#39;__len__&#39;</span><span class="p">),</span> <span class="n">args</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s">&#39;__len__&#39;</span><span class="p">),</span> <span class="n">args</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">decorator_fn</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="nd">@functools.wraps</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">wrapper_fn</span><span class="p">(</span><span class="o">*</span><span class="n">fn_args</span><span class="p">,</span> <span class="o">**</span><span class="n">fn_kwargs</span><span class="p">):</span>
            <span class="n">context</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">if</span> <span class="n">context_arg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">context</span> <span class="o">=</span> <span class="n">fn_args</span><span class="p">[</span><span class="n">context_arg</span><span class="p">]</span><span class="o">.</span><span class="n">conversion_context</span><span class="p">()</span>

            <span class="n">fn_args</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">fn_args</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">arg_num</span><span class="p">,</span> <span class="n">arg_units</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>

                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fn_args</span><span class="p">[</span><span class="n">arg_num</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="n">fn_args</span><span class="p">[</span><span class="n">arg_num</span><span class="p">]</span> <span class="o">=</span> <span class="n">Unit</span><span class="p">(</span><span class="n">fn_args</span><span class="p">[</span><span class="n">arg_num</span><span class="p">])</span>

                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">fn_args</span><span class="p">[</span><span class="n">arg_num</span><span class="p">],</span> <span class="s">&quot;in_units&quot;</span><span class="p">):</span>
                    <span class="n">fn_args</span><span class="p">[</span><span class="n">arg_num</span><span class="p">]</span> <span class="o">=</span> <span class="n">fn_args</span><span class="p">[</span>
                        <span class="n">arg_num</span><span class="p">]</span><span class="o">.</span><span class="n">in_units</span><span class="p">(</span><span class="n">arg_units</span><span class="p">,</span> <span class="o">**</span><span class="n">context</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">arg_name</span><span class="p">,</span> <span class="n">arg_units</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fn_kwargs</span><span class="p">[</span><span class="n">arg_name</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="n">fn_kwargs</span><span class="p">[</span><span class="n">arg_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">Unit</span><span class="p">(</span><span class="n">fn_kwargs</span><span class="p">[</span><span class="n">arg_name</span><span class="p">])</span>

                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">fn_kwargs</span><span class="p">[</span><span class="n">arg_name</span><span class="p">],</span> <span class="s">&quot;in_units&quot;</span><span class="p">):</span>
                    <span class="n">fn_kwargs</span><span class="p">[</span><span class="n">arg_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">fn_kwargs</span><span class="p">[</span>
                        <span class="n">arg_name</span><span class="p">]</span><span class="o">.</span><span class="n">in_units</span><span class="p">(</span><span class="n">arg_units</span><span class="p">,</span> <span class="o">**</span><span class="n">context</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">x</span><span class="p">(</span><span class="o">*</span><span class="n">fn_args</span><span class="p">,</span> <span class="o">**</span><span class="n">fn_kwargs</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">wrapper_fn</span>

    <span class="k">return</span> <span class="n">decorator_fn</span>

</div>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">config_parser</span>


<span class="k">def</span> <span class="nf">__is_clean_name</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s">&#39;[^0-9a-zA-Z_]&#39;</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">False</span>
    <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s">&#39;^[^a-zA-Z_]+&#39;</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">False</span>
    <span class="k">if</span> <span class="n">keyword</span><span class="o">.</span><span class="n">iskeyword</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">False</span>
    <span class="k">return</span> <span class="bp">True</span>

<span class="k">for</span> <span class="n">new_unit_name</span> <span class="ow">in</span> <span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="o">.</span><span class="n">strip</span><span class="p">,</span> <span class="n">config_parser</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;irreducible-units&#39;</span><span class="p">,</span> <span class="s">&#39;names&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;,&quot;</span><span class="p">)):</span>
    <span class="n">new_unit</span> <span class="o">=</span> <span class="n">IrreducibleUnit</span><span class="p">(</span><span class="n">new_unit_name</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">__is_clean_name</span><span class="p">(</span><span class="n">new_unit_name</span><span class="p">):</span>
        <span class="nb">globals</span><span class="p">()[</span><span class="n">new_unit_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_unit</span>

<span class="k">for</span> <span class="n">new_unit_name</span><span class="p">,</span> <span class="n">new_unit_definition</span> <span class="ow">in</span> <span class="n">config_parser</span><span class="o">.</span><span class="n">items</span><span class="p">(</span><span class="s">&quot;named-units&quot;</span><span class="p">):</span>
    <span class="n">new_unit</span> <span class="o">=</span> <span class="n">NamedUnit</span><span class="p">(</span><span class="n">new_unit_name</span><span class="p">,</span> <span class="n">new_unit_definition</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">__is_clean_name</span><span class="p">(</span><span class="n">new_unit_name</span><span class="p">):</span>
        <span class="nb">globals</span><span class="p">()[</span><span class="n">new_unit_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_unit</span>

<span class="k">for</span> <span class="n">unit_name</span><span class="p">,</span> <span class="n">latex</span> <span class="ow">in</span> <span class="n">config_parser</span><span class="o">.</span><span class="n">items</span><span class="p">(</span><span class="s">&quot;units-latex&quot;</span><span class="p">):</span>
    <span class="n">_registry</span><span class="p">[</span><span class="n">unit_name</span><span class="p">]</span><span class="o">.</span><span class="n">_latex</span> <span class="o">=</span> <span class="n">latex</span>


<span class="n">_default_units</span> <span class="o">=</span> <span class="p">{}</span>

<span class="k">for</span> <span class="n">a_</span><span class="p">,</span> <span class="n">b_</span> <span class="ow">in</span> <span class="n">config_parser</span><span class="o">.</span><span class="n">items</span><span class="p">(</span><span class="s">&quot;default-array-dimensions&quot;</span><span class="p">):</span>
    <span class="n">_default_units</span><span class="p">[</span><span class="n">a_</span><span class="p">]</span> <span class="o">=</span> <span class="n">Unit</span><span class="p">(</span><span class="n">b_</span><span class="p">)</span>


<div class="viewcode-block" id="has_units"><a class="viewcode-back" href="../../essentials.html#pynbody.units.has_units">[docs]</a><span class="k">def</span> <span class="nf">has_units</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns True if the specified object has a meaningful units attribute&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s">&#39;units&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">units</span><span class="p">,</span> <span class="n">UnitBase</span><span class="p">):</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">units</span><span class="p">,</span> <span class="s">&#39;_no_unit&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">False</span></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../index.html">pynbody 0.18-alpha documentation</a> &raquo;</li>
          <li><a href="../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2011-13, pynbody team &lt;http://code.google.com/p/pynbody/people/list&gt;).
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>
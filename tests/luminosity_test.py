import warnings

import numpy.testing as npt
import pytest

import pynbody

results = {'v1':
               {'v': [ -8.4318334 ,  -7.52727191,  -8.55756858,  -7.30202671,
               -8.41616925,  -8.5901894 ,  -7.31028468,  -8.12565159,
               -7.31518039,  -8.27380601,  -7.4544367 ,  -7.33062685,
               -7.49427742,  -7.54732334,  -8.48062923,  -7.55131115,
               -7.4688558 ,  -7.35175012,  -7.30811722,  -7.32948685,
               -7.31248768,  -7.35615838,  -7.35173455,  -7.3533272 ,
               -7.80099082,  -8.43374329,  -8.10182908,  -7.36861107,
               -7.29332819,  -7.60060675,  -8.40313886,  -7.32783517,
               -7.33496155,  -7.43744317,  -7.32186524,  -7.39949592,
               -7.38406259,  -7.67425681,  -7.45984135,  -7.51371185,
               -7.49645462,  -7.52048843,  -7.70642421,  -7.59838561,
               -7.95290614,  -7.79978215,  -7.81983398,  -8.10895307,
               -8.18092218,  -8.43809995,  -8.75108248,  -8.87727426,
               -9.8070235 , -12.2256384 ],
               'i': [ -9.37239259,  -8.61520494,  -9.51952974,  -8.48018286,
               -9.41245481,  -9.55877876,  -8.47512415,  -9.17036249,
               -8.48540295,  -9.30909755,  -8.57185253,  -8.49045091,
               -8.61798039,  -8.65119512,  -9.47017277,  -8.65575078,
               -8.59919548,  -8.50870863,  -8.49204726,  -8.49641349,
               -8.49738915,  -8.51396949,  -8.51061231,  -8.51133183,
               -8.86347368,  -9.45457537,  -9.14830751,  -8.52422242,
               -8.48938537,  -8.69776393,  -9.43459827,  -8.51486725,
               -8.52239391,  -8.58473181,  -8.51439489,  -8.55252743,
               -8.56635275,  -8.75172718,  -8.61466123,  -8.65943626,
               -8.65131001,  -8.66957709,  -8.81021473,  -8.74422862,
               -9.00397257,  -8.92882127,  -8.94942337,  -9.1815767 ,
               -9.27461736,  -9.48783697,  -9.760549  ,  -9.92439524,
              -10.58895997, -12.69117395],
               'I': [ -9.37239259,  -8.61520494,  -9.51952974,  -8.48018286, # tests case-insensitivity of old tables
               -9.41245481,  -9.55877876,  -8.47512415,  -9.17036249,
               -8.48540295,  -9.30909755,  -8.57185253,  -8.49045091,
               -8.61798039,  -8.65119512,  -9.47017277,  -8.65575078,
               -8.59919548,  -8.50870863,  -8.49204726,  -8.49641349,
               -8.49738915,  -8.51396949,  -8.51061231,  -8.51133183,
               -8.86347368,  -9.45457537,  -9.14830751,  -8.52422242,
               -8.48938537,  -8.69776393,  -9.43459827,  -8.51486725,
               -8.52239391,  -8.58473181,  -8.51439489,  -8.55252743,
               -8.56635275,  -8.75172718,  -8.61466123,  -8.65943626,
               -8.65131001,  -8.66957709,  -8.81021473,  -8.74422862,
               -9.00397257,  -8.92882127,  -8.94942337,  -9.1815767 ,
               -9.27461736,  -9.48783697,  -9.760549  ,  -9.92439524,
              -10.58895997, -12.69117395]
               },
           'default':
               {'V': [ -7.21908072,  -7.26172674,  -7.2709919 ,  -7.27823576,
                       -7.28421337,  -7.2887819 ,  -7.29261729,  -7.2969965 ,
                       -7.30186887,  -7.30682813,  -7.245304  ,  -7.31569566,
                       -7.31929239,  -7.32224088,  -7.32489712,  -7.32944375,
                       -7.3341978 ,  -7.33867096,  -7.34285872,  -7.34663275,
                       -7.35129572,  -7.35636018,  -7.36290663,  -7.37033125,
                       -7.37839912,  -7.38634742,  -7.39450344,  -7.40328165,
                       -7.41235438,  -7.42200907,  -7.43289982,  -7.44507114,
                       -7.4580651 ,  -7.47235894,  -7.48756181,  -7.50249322,
                       -7.5236072 ,  -7.5478029 ,  -7.57665146,  -7.6056062 ,
                       -7.63882191,  -7.67564015,  -7.71999911,  -7.77548245,
                       -7.83901105,  -7.91747192,  -8.01145392,  -8.1192399 ,
                       -8.26139723,  -8.44130441,  -8.68707013,  -9.13148893,
                       -9.85689076, -12.41728584],
                'i': [ -8.13442232,  -8.13442232,  -8.13442232,  -8.13442232, # <-- SDSS i-band (AB-calibrated)
                       -8.13990849,  -8.14476057,  -8.148834  ,  -8.15348501,
                       -8.15865978,  -8.16392683,  -8.10268272,  -8.17334473,
                       -8.17716469,  -8.18029618,  -8.18311728,  -8.18794609,
                       -8.19299521,  -8.19774599,  -8.20219366,  -8.20620194,
                       -8.21115431,  -8.2165331 ,  -8.22348585,  -8.23137128,
                       -8.23993988,  -8.2481067 ,  -8.25648611,  -8.26550475,
                       -8.27482598,  -8.28474511,  -8.29593416,  -8.30843885,
                       -8.32178871,  -8.33647406,  -8.35098734,  -8.36378443,
                       -8.38188033,  -8.40261744,  -8.42734233,  -8.45215822,
                       -8.48062601,  -8.51218138,  -8.54654719,  -8.58806429,
                       -8.63560151,  -8.69431225,  -8.78952554,  -8.90383588,
                       -9.0290412 ,  -9.1958842 ,  -9.3981834 ,  -9.78108974,
                      -10.2037995 , -12.73000575],
                'I': [ -8.50325288,  -8.53487963,  -8.54175077,  -8.54712289, # <-- Vega-calibrated
                       -8.55155595,  -8.55494403,  -8.55778839,  -8.56103606,
                       -8.56464946,  -8.5683273 ,  -8.50563741,  -8.57490356,
                       -8.57757093,  -8.57975756,  -8.58172746,  -8.58509928,
                       -8.58862494,  -8.59194228,  -8.59504797,  -8.59784684,
                       -8.60130494,  -8.6050608 ,  -8.60991572,  -8.6154219 ,
                       -8.62140511,  -8.62813807,  -8.6350495 ,  -8.64248818,
                       -8.65017644,  -8.65835785,  -8.6675867 ,  -8.67790071,
                       -8.68891182,  -8.70102445,  -8.71390741,  -8.72656033,
                       -8.74445236,  -8.76495586,  -8.78940221,  -8.81393853,
                       -8.84208561,  -8.87328548,  -8.91303364,  -8.96361674,
                       -9.02153456,  -9.09306583,  -9.17874743,  -9.27615613,
                       -9.40426797,  -9.56032956,  -9.76032192, -10.10181398,
                      -10.56706007, -13.12043619]
                }
}

@pytest.fixture
def testfile():
    f = pynbody.load("testdata/gasoline_ahf/g15784.lr.01024.gz")

    with warnings.catch_warnings(record=True) as w:
        warnings.filterwarnings('ignore')
        f.st['massform']  # noqa - trigger starlog load and ignore any warnings

    return f

def test_luminosity(testfile):
    for ssp_name, tests in results.items():
        with pynbody.analysis.luminosity.use_custom_ssp_table(ssp_name):
            for band, result in tests.items():
                mag = pynbody.analysis.luminosity.calc_mags(testfile.st, band=band)
                print(repr(mag[::5000]))
                npt.assert_allclose(mag[::5000], result, rtol=1e-5)




def test_halo_magnitude(testfile):
    expected_results = {'V': -21.63265408, 'U': -21.148044, 'u': -20.7919931}
    h = testfile.halos()
    for band, expected in expected_results.items():
        print(h[0].st[band+"_mag"])
        npt.assert_allclose(pynbody.analysis.luminosity.halo_mag(h[0], band), expected)

def test_halo_half_light(testfile):
    expected_results = {('V', False): 3.24773816, ('i', False): 3.164463,
                        ('i', True): 2.959095}
    testfile.physical_units()
    h = testfile.halos()
    pynbody.analysis.faceon(h[0])
    for (band, cylindrical), expected in expected_results.items():
        npt.assert_allclose(pynbody.analysis.luminosity.half_light_r(h[0], band, cylindrical=cylindrical), expected)
